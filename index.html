<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>POS System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --accent: #22c55e;
      --danger: #ef4444;
      --sidebar-bg: linear-gradient(180deg, #232946 60%, #2563eb 100%);
      --sidebar-active: #fff;
      --sidebar-hover: #3b82f6;
      --sidebar-text: #cbd5e1;
      --sidebar-active-bg: #1e293b;
      --header-bg: #fff;
      --header-shadow: 0 2px 8px #0001;
      --card-bg: #fff;
      --card-radius: 18px;
      --card-shadow: 0 4px 24px #0002;
      --border: #e5e7eb;
      --table-header: #f1f5f9;
      --table-row: #f8fafc;
      --table-hover: #e0e7ef;
      --input-bg: #f1f5f9;
      --input-focus: #2563eb33;
      --btn-radius: 7px;
      --btn-shadow: 0 2px 8px #2563eb22;
      --font: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    body {
      margin: 0;
      font-family: var(--font);
      background: #f3f4f6;
      color: #232946;
      min-height: 100vh;
    }
    .pos-header {
      background: var(--header-bg);
      color: var(--primary-dark);
      padding: 0 0 0 0;
      font-size: 1.6rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-align: left;
      box-shadow: var(--header-shadow);
      display: flex;
      align-items: center;
      height: 64px;
      z-index: 10;
      position: sticky;
      top: 0;
    }
    .pos-header .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      font-weight: 700;
      margin-left: 32px;
      color: var(--primary);
    }
    .pos-header .logo svg {
      width: 32px;
      height: 32px;
      display: inline-block;
    }
    .pos-layout {
      display: flex;
      min-height: 100vh;
    }
    .pos-sidebar {
      width: 230px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      padding-top: 30px;
      transition: left 0.3s;
      min-height: 100vh;
      box-shadow: 2px 0 12px #0001;
      z-index: 2;
    }
    .pos-sidebar .logo {
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: 2px;
      color: #fff;
    }
    .pos-sidebar button {
      background: none;
      border: none;
      color: var(--sidebar-text);
      text-align: left;
      padding: 15px 36px 15px 28px;
      font-size: 1.05rem;
      cursor: pointer;
      border-left: 4px solid transparent;
      display: flex;
      align-items: center;
      gap: 13px;
      transition: background 0.18s, border-color 0.18s, color 0.18s;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .pos-sidebar button .icon {
      font-size: 1.2em;
      width: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pos-sidebar button.active, .pos-sidebar button:hover {
      background: var(--sidebar-active-bg);
      border-left: 4px solid var(--accent);
      color: var(--sidebar-active);
    }
    .pos-main {
      flex: 1;
      padding: 48px 36px 36px 36px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-width: 0;
    }
    .pos-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 32px 28px 24px 28px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
      max-width: 100%;
      overflow-x: auto;
      min-width: 0;
    }
    .pos-card h2 {
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.25rem;
      color: var(--primary-dark);
      font-weight: 600;
    }
    .pos-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-bottom: 18px;
    }
    .pos-form-row label {
      flex: 1 1 210px;
      display: flex;
      flex-direction: column;
      font-size: 1rem;
      color: #232946;
      font-weight: 500;
    }
    .pos-form-row input, .pos-form-row select {
      margin-top: 5px;
      padding: 10px 12px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 1.05rem;
      background: var(--input-bg);
      transition: border 0.2s, box-shadow 0.2s;
      font-family: var(--font);
    }
    .pos-form-row input:focus, .pos-form-row select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--input-focus);
      outline: none;
    }
    .pos-form-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }
    .pos-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      padding: 10px 26px;
      font-size: 1.05rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--btn-shadow);
      display: inline-flex;
      align-items: center;
      gap: 7px;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .pos-btn.cancel {
      background: #aaa;
      color: #fff;
      box-shadow: none;
    }
    .pos-btn:hover {
      background: var(--primary-dark);
      box-shadow: 0 4px 16px #2563eb33;
    }
    .pos-btn.cancel:hover {
      background: #888;
    }
    .pos-search-bar-wrap {
      margin: 0 0 18px 0;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    .pos-search-bar {
      padding: 10px 14px 10px 38px;
      border-radius: 7px;
      border: 1.5px solid var(--border);
      font-size: 1.05rem;
      background: var(--input-bg) url('data:image/svg+xml;utf8,<svg fill="%23999" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99c.41.41 1.09.41 1.5 0s.41-1.09 0-1.5l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>') no-repeat 10px center;
      width: 260px;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .pos-search-bar:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--input-focus);
      outline: none;
    }
    .pos-table-wrap {
      overflow-x: auto;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 8px #0001;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: #fff;
      font-size: 1.01rem;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 13px 10px;
      text-align: left;
    }
    th {
      background: var(--table-header);
      color: #232946;
      font-weight: 600;
      border-top: 1px solid var(--border);
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background: var(--table-row);
    }
    tr:hover {
      background: var(--table-hover);
    }
    .actions button {
      margin-right: 6px;
      padding: 7px 15px;
      font-size: 1.05rem;
      border-radius: 5px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      box-shadow: 0 2px 8px #2563eb22;
    }
    .actions button:last-child {
      background: var(--danger);
    }
    .actions button:hover {
      opacity: 0.88;
    }
    .edit-row {
      background: #fffbe6 !important;
    }
    .error {
      color: var(--danger);
      margin-bottom: 10px;
      font-size: 1rem;
    }
    /* Hamburger for mobile */
    .hamburger {
      display: none;
      position: absolute;
      left: 18px;
      top: 18px;
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      z-index: 100;
      cursor: pointer;
    }
    .hamburger span, .hamburger span:before, .hamburger span:after {
      display: block;
      position: absolute;
      width: 28px;
      height: 4px;
      background: #2563eb;
      border-radius: 2px;
      transition: all 0.3s;
      content: '';
    }
    .hamburger span {
      top: 14px;
      left: 2px;
    }
    .hamburger span:before {
      content: '';
      top: -10px;
      left: 0;
      position: absolute;
    }
    .hamburger span:after {
      content: '';
      top: 10px;
      left: 0;
      position: absolute;
    }
    @media (max-width: 1100px) {
      .pos-main {
        padding: 24px 4vw;
      }
      .pos-card {
        padding: 16px 4px 10px 4px;
      }
    }
    @media (max-width: 900px) {
      .pos-layout {
        flex-direction: column;
      }
      .pos-sidebar {
        position: fixed;
        left: -240px;
        top: 0;
        height: 100vh;
        z-index: 200;
        width: 220px;
        transition: left 0.3s;
      }
      .pos-sidebar.open {
        left: 0;
      }
      .pos-main {
        padding: 18px 2vw;
      }
      .hamburger {
        display: block;
      }
      .pos-header .logo {
        margin-left: 60px;
      }
    }
    @media (max-width: 600px) {
      .pos-main {
        padding: 7px 1vw;
      }
      .pos-card {
        padding: 8px 2px 6px 2px;
      }
      .pos-form-row label {
        flex: 1 1 100%;
      }
      th, td {
        font-size: 0.97rem;
        padding: 7px 4px;
      }
      .pos-search-bar {
        width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="pos-header">
    <div class="logo">
      <svg viewBox="0 0 32 32" fill="none"><rect x="2" y="8" width="28" height="16" rx="4" fill="#2563eb"/><rect x="7" y="13" width="18" height="6" rx="2" fill="#fff"/><rect x="12" y="20" width="8" height="2" rx="1" fill="#fff"/></svg>
      POS System
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span>
    </button>
  </div>
  <div class="pos-layout">
    <nav class="pos-sidebar" id="sidebar">
      <div class="logo">POS Menu</div>
      <button id="tab-products" class="active" onclick="switchTab('products')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="2" y="5" width="16" height="10" rx="2" fill="#fff" fill-opacity="0.2"/><rect x="4" y="7" width="12" height="6" rx="1" fill="#fff" fill-opacity="0.7"/></svg></span>
        Products
      </button>
      <button id="tab-customers" onclick="switchTab('customers')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="7" r="3" fill="#fff" fill-opacity="0.7"/><rect x="4" y="12" width="12" height="5" rx="2.5" fill="#fff" fill-opacity="0.2"/></svg></span>
        Customers
      </button>
      <button id="tab-categories" onclick="switchTab('categories')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="3" y="5" width="14" height="10" rx="2" fill="#fff" fill-opacity="0.2"/><rect x="5" y="7" width="10" height="6" rx="1" fill="#fff" fill-opacity="0.7"/></svg></span>
        Categories
      </button>
      <button id="tab-unit" onclick="switchTab('unit')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="4" y="9" width="12" height="2" rx="1" fill="#fff" fill-opacity="0.7"/><rect x="4" y="13" width="12" height="2" rx="1" fill="#fff" fill-opacity="0.2"/></svg></span>
        Unit
      </button>
      <button id="tab-supplier" onclick="switchTab('supplier')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="3" y="7" width="14" height="8" rx="2" fill="#fff" fill-opacity="0.2"/><rect x="6" y="10" width="8" height="3" rx="1.5" fill="#fff" fill-opacity="0.7"/></svg></span>
        Supplier
      </button>
      <button id="tab-sales" onclick="switchTab('sales')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><path d="M3 17V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10" stroke="#fff" stroke-width="2"/><rect x="7" y="11" width="6" height="4" rx="1" fill="#fff" fill-opacity="0.7"/></svg></span>
        <b style="font-size:1.08em;letter-spacing:0.5px;">Sales (POS)</b>
      </button>
      <button id="tab-sales-history" onclick="switchTab('sales-history')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="3" y="7" width="14" height="8" rx="2" fill="#fff" fill-opacity="0.2"/><rect x="6" y="10" width="8" height="3" rx="1.5" fill="#fff" fill-opacity="0.7"/></svg></span>
        Sales History
      </button>
      <button id="tab-staff" onclick="switchTab('staff')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="7" r="3" fill="#fff" fill-opacity="0.7"/><rect x="4" y="12" width="12" height="5" rx="2.5" fill="#fff" fill-opacity="0.2"/></svg></span>
        Staff
      </button>
      <button id="tab-settings" onclick="switchTab('settings')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" stroke="#fff" stroke-width="2" fill="none"/><path d="M10 6v4l3 3" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg></span>
        Settings
      </button>
      <button id="tab-reports" onclick="switchTab('reports')">
        <span class="icon"><svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="3" y="5" width="14" height="10" rx="2" fill="#fff" fill-opacity="0.2"/><rect x="5" y="7" width="10" height="6" rx="1" fill="#fff" fill-opacity="0.7"/></svg></span>
        Reports
      </button>
    </nav>
    <main class="pos-main">
      <div class="pos-card" id="crud-app"></div>
    </main>
  </div>
  <script>
    // Hamburger menu for mobile
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    hamburger.onclick = function() {
      sidebar.classList.toggle('open');
    };
    document.body.onclick = function(e) {
      if (window.innerWidth <= 900 && sidebar.classList.contains('open')) {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
          sidebar.classList.remove('open');
        }
      }
    };

    // Table configs
    const tables = {
      products: {
        label: "Products",
        endpoint: "http://localhost/POS%20SYSTEM/api/products.php",
        fields: [
          {name: "productname", label: "Product Name", required: true},
          {name: "categories", label: "Categories", type: "select", source: "categories"},
          {name: "barcode", label: "Barcode"},
          {name: "cost", label: "Cost", type: "number"},
          {name: "price", label: "Price", type: "number"},
          {name: "stock", label: "Stock", type: "number"},
          {name: "unit", label: "Unit", type: "select", source: "unit"},
          {name: "supplier", label: "Supplier", type: "select", source: "supplier"},
          {name: "note", label: "Note"},
          {name: "stock_noti", label: "Stock Noti Threshold", type: "number", required: false}
        ]
      },
      customers: {
        label: "Customers",
        endpoint: "http://localhost/POS%20SYSTEM/api/customers.php",
        fields: [
          {name: "name", label: "Name", required: true},
          {name: "adress", label: "Address"},
          {name: "category", label: "Category"},
          {name: "note", label: "Note"},
          {name: "phonenumber", label: "Phone"}
        ]
      },
      categories: {
        label: "Categories",
        endpoint: "http://localhost/POS%20SYSTEM/api/categories.php",
        fields: [
          {name: "categoryname", label: "Category Name", required: true}
        ]
      },
      unit: {
        label: "Unit",
        endpoint: "http://localhost/POS%20SYSTEM/api/unit.php",
        fields: [
          {name: "unit", label: "Unit", required: true}
        ]
      },
      supplier: {
        label: "Supplier",
        endpoint: "http://localhost/POS%20SYSTEM/api/supplier.php",
        fields: [
          {name: "name", label: "Name", required: true},
          {name: "adress", label: "Address"},
          {name: "phonenumber", label: "Phone"},
          {name: "note", label: "Note"}
        ]
      },
      staff: {
        label: "Staff",
        endpoint: "http://localhost/POS%20SYSTEM/api/staff.php",
        fields: [
          {name: "name", label: "Name", required: true},
          {name: "role", label: "Role"},
          {name: "phone", label: "Phone"},
          {name: "email", label: "Email"},
          {name: "note", label: "Note"}
        ]
      },
      sales: {
        label: "Sales",
        endpoint: "http://localhost/POS%20SYSTEM/api/sales.php",
        isSale: true
      }
    };

    
    let currentTab = 'products';
    let editingId = null;
    let dataCache = [];
    const preloadData = {};

    let cart = [];
    let saleForm = { product_id: '', quantity: 1, price: 0, customer_id: '', staff_id: '', note: '', discount: 0, payment: 0 };
    let productsList = [], customersList = [], staffList = [];
    let saleMessage = '';
    let saleLoading = false;
    let showInvoice = false;
    let lastInvoice = null;
    let salesHistory = [];
    let stockAlertShown = false;

    function switchTab(tab) {
      currentTab = tab;
      editingId = null;
      document.querySelectorAll('.pos-sidebar button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      if (window.innerWidth <= 900) sidebar.classList.remove('open');
      if (tab === 'sales-history') {
        renderSalesHistoryTab();
        return;
      }
      if (tab === 'reports') {
        renderReportsPage();
        return;
      }
      if (tab === 'settings') {
        renderSettingsPage();
        return;
      }
      renderCRUD();
    }

    function preloadSelectData() {
      const sources = ["categories", "unit", "supplier"];
      return Promise.all(sources.map(src =>
        fetch(tables[src].endpoint)
          .then(res => res.json())
          .then(data => { preloadData[src] = data; })
      ));
    }

    function preloadSaleData() {
      return Promise.all([
        fetch(tables.products.endpoint).then(r=>r.json()).then(d=>{productsList=d;}),
        fetch(tables.customers.endpoint).then(r=>r.json()).then(d=>{customersList=d;}),
        fetch(tables.staff.endpoint).then(r=>r.json()).then(d=>{staffList=d;})
      ]);
    }

    function renderCRUD(afterRender) {
      if (currentTab === 'sales') {
        renderSaleUI();
        return;
      }
      const cfg = tables[currentTab];
      preloadSelectData().then(() => {
        let html = `<h2>${cfg.label}</h2>
          <div id="error" class="error"></div>
          <form id="crud-form" onsubmit="event.preventDefault(); ${editingId ? 'submitEdit()' : 'submitAdd()'}">
            <div class="pos-form-row">`;
        cfg.fields.forEach(f => {
          if (f.type === "select" && preloadData[f.source]) {
            html += `<label>${f.label}
              <select name="${f.name}" ${f.required ? 'required' : ''}>
                <option value="">-- Select --</option>`;
            preloadData[f.source].forEach(opt => {
              let label = opt.categoryname || opt.unit || opt.name;
              html += `<option value="${opt.id}">${label}</option>`;
            });
            html += `</select></label>`;
          } else {
            html += `<label>${f.label}
              <input name="${f.name}" ${f.type ? `type=\"${f.type}\"` : ''} ${f.required ? 'required' : ''}>
            </label>`;
          }
        });
        html += `</div>
          <div class="pos-form-actions">
            <button type="submit" class="pos-btn">${editingId ? '<svg width="18" height="18" fill="none" viewBox="0 0 20 20"><path d="M4 13.5V16h2.5l7.37-7.37-2.5-2.5L4 13.5zm11.71-6.29a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.92 3.92 1.83-1.83z" fill="#fff"/></svg> Update' : '<svg width=\"18\" height=\"18\" fill=\"none\" viewBox=\"0 0 20 20\"><path d=\"M10 5v10m5-5H5\" stroke=\"#fff\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg> Add'}</button>`;
        if (editingId) html += `<button type="button" class="pos-btn cancel" onclick="cancelEdit()"><svg width="18" height="18" fill="none" viewBox="0 0 20 20"><path d="M6 6l8 8M6 14L14 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg> Cancel</button>`;
        html += `</div></form>
          <div class="pos-search-bar-wrap"><input id="search-bar" class="pos-search-bar" type="text" placeholder="Search..." oninput="onSearchInput()"></div>
          <div class="pos-table-wrap">
            <table><thead><tr>`;
        cfg.fields.forEach(f => html += `<th>${f.label}</th>`);
        html += `<th>Actions</th></tr></thead><tbody id="crud-tbody"></tbody></table>
          </div>`;
        document.getElementById('crud-app').innerHTML = html;
        loadData();
        if (afterRender) afterRender();
      });
    }

    function renderSaleUI() {
      preloadSaleData().then(() => {
        fetchSalesHistory().then(() => {
          let productOptions = productsList.map(p => `<option value="${p.id}" data-price="${p.price}">${p.productname}</option>`).join('');
          let customerOptions = customersList.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
          let staffOptions = staffList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
          let cartRows = cart.map((item, i) => `
            <tr>
              <td>${productsList.find(p=>p.id==item.product_id)?.productname||''}</td>
              <td><input type="number" min="1" value="${item.quantity}" style="width:60px" onchange="editCartQty(${i}, this.value)"></td>
              <td>${item.price}</td>
              <td>${item.subtotal}</td>
              <td><button class="pos-btn cancel" style="padding:4px 10px;font-size:0.95em" onclick="removeCartItem(${i})">Remove</button></td>
            </tr>
          `).join('');
          let subtotal = cart.reduce((sum, item) => sum + Number(item.subtotal), 0);
          let discount = Number(saleForm.discount)||0;
          let discountAmount = discount > 0 ? (discount < 1 ? subtotal * discount : discount) : 0;
          let grandTotal = subtotal - discountAmount;
          let payment = Number(saleForm.payment)||0;
          let change = payment - grandTotal;
          // Stock check logic
          let selectedProduct = productsList.find(p=>p.id==saleForm.product_id);
          let stockOk = true;
          let stockMsg = '';
          if (selectedProduct) {
            let threshold = Number(selectedProduct.stock_noti ?? 5);
            let stock = Number(selectedProduct.stock ?? 0);
            let qty = Number(saleForm.quantity) || 1;
            if (stock < threshold) {
              stockOk = false;
              stockMsg = `Stock is below notification threshold!`;
            }
            if (stock < qty) {
              stockOk = false;
              stockMsg = `Not enough stock!`;
            }
            if (stock <= 0) {
              stockOk = false;
              stockMsg = `Out of stock!`;
            }
          }
          document.getElementById('crud-app').innerHTML = `
            <h2>Sales (POS)</h2>
            <form id="sale-form" onsubmit="event.preventDefault(); addToCart()">
              <div class="pos-form-row">
                <label>Product
                  <select name="product_id" required onchange="onSaleProductChange(this.value)">
                    <option value="">-- Select Product --</option>
                    ${productOptions}
                  </select>
                </label>
                <label>Quantity
                  <input name="quantity" type="number" min="1" value="${saleForm.quantity}" required onchange="onSaleQtyChange(this.value)">
                </label>
                <label>Price
                  <input name="price" type="number" min="0" step="0.01" value="${saleForm.price}" required onchange="onSalePriceChange(this.value)">
                </label>
                <label>Subtotal
                  <input name="subtotal" type="number" value="${saleForm.quantity * saleForm.price}" readonly>
                </label>
              </div>
              <div class="pos-form-actions">
                <button type="submit" class="pos-btn" id="add-to-cart-btn" ${!stockOk ? 'disabled' : ''}><svg width="18" height="18" fill="none" viewBox="0 0 20 20"><path d="M10 5v10m5-5H5" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg> Add to Cart</button>
              </div>
              ${!stockOk && saleForm.product_id ? `<div class='error' style='text-align:center;'>${stockMsg}</div>` : ''}
            </form>
            <div class="pos-card" style="margin-bottom:18px;">
              <h3 style="margin:0 0 10px 0;font-size:1.1em;">Cart</h3>
              <div class="pos-table-wrap">
                <table><thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th><th></th></tr></thead>
                <tbody>${cartRows || '<tr><td colspan="5" style="text-align:center;color:#aaa;">No items</td></tr>'}</tbody></table>
              </div>
              <div style="text-align:right;font-size:1.1em;margin-top:10px;">Subtotal: <b>${subtotal.toFixed(2)}</b></div>
            </div>
            <form id="checkout-form" onsubmit="event.preventDefault(); checkoutSale()">
              <div class="pos-form-row">
                <label>Customer
                  <select name="customer_id" required>
                    <option value="">-- Select Customer --</option>
                    ${customerOptions}
                  </select>
                </label>
                <label>Staff
                  <select name="staff_id" required>
                    <option value="">-- Select Staff --</option>
                    ${staffOptions}
                  </select>
                </label>
                <label>Discount
                  <input name="discount" type="number" min="0" step="0.01" value="${saleForm.discount}" placeholder="0"> <span style="font-size:0.95em;color:#888;">(amount or 0.05 for 5%)</span>
                </label>
                <label>Payment
                  <input name="payment" type="number" min="0" step="0.01" value="${saleForm.payment}" placeholder="0">
                </label>
                <label>Note
                  <input name="note" type="text">
                </label>
              </div>
              <div style="text-align:right;font-size:1.1em;margin-bottom:8px;">
                Discount: <b>${discountAmount.toFixed(2)}</b> &nbsp; Grand Total: <b>${grandTotal.toFixed(2)}</b> &nbsp; Change: <b style="color:${change<0?'#e74c3c':'#22c55e'}">${change.toFixed(2)}</b>
              </div>
              <div class="pos-form-actions">
                <button type="submit" class="pos-btn" ${cart.length===0||saleLoading?'disabled':''}><svg width="18" height="18" fill="none" viewBox="0 0 20 20"><rect x="4" y="9" width="12" height="2" rx="1" fill="#fff"/></svg> Checkout</button>
                ${saleLoading?'<span class="pos-btn" style="background:#eee;color:#888;cursor:wait;"><svg width="18" height="18" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" stroke="#2563eb" stroke-width="3" stroke-dasharray="20 20" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 10 10" to="360 10 10" dur="0.7s" repeatCount="indefinite"/></circle></svg> Processing...</span>':''}
              </div>
              <div class="error" style="text-align:center;">${saleMessage}</div>
            </form>
            ${showInvoice && lastInvoice ? renderInvoiceModal(lastInvoice) : ''}
          `;
          // Restore form values
          const form = document.getElementById('sale-form');
          if (form) {
            form.product_id.value = saleForm.product_id;
            form.quantity.value = saleForm.quantity;
            form.price.value = saleForm.price;
            form.subtotal.value = saleForm.quantity * saleForm.price;
          }
          const checkoutForm = document.getElementById('checkout-form');
          if (checkoutForm) {
            checkoutForm.customer_id.value = saleForm.customer_id;
            checkoutForm.staff_id.value = saleForm.staff_id;
            checkoutForm.note.value = saleForm.note;
            checkoutForm.discount.value = saleForm.discount;
            checkoutForm.payment.value = saleForm.payment;
          }
        });
      });
    }

    function loadData() {
      const cfg = tables[currentTab];
      fetch(cfg.endpoint)
        .then(res => res.json())
        .then(data => {
          dataCache = data;
          renderTableRows();
        });
    }

    function renderTableRows() {
      const cfg = tables[currentTab];
      const search = (document.getElementById('search-bar')?.value || '').toLowerCase();
      const tbody = document.getElementById('crud-tbody');
      tbody.innerHTML = '';
      let filtered = dataCache;
      if (search) {
        filtered = dataCache.filter(row =>
          cfg.fields.some(f => (row[f.name] + '').toLowerCase().includes(search))
        );
      }
      filtered.forEach(row => {
        const isEdit = editingId == row.id;
        let isLowStock = false;
        if (currentTab === 'products') {
          const stock = Number(row['stock'] ?? 0);
          const threshold = Number(row['stock_noti'] ?? 5);
          isLowStock = stock < threshold;
        }
        let tr = `<tr${isEdit ? ' class="edit-row"' : ''}${isLowStock ? ' style="background:#fff0f0;"' : ''}>`;
        if (currentTab === 'products') {
          // Show image as first column
          tr += `<td>${row.image_url ? `<img src='${row.image_url}' style='max-width:48px;max-height:48px;border-radius:6px;'/>` : ''}</td>`;
        }
        cfg.fields.forEach(f => {
          if (f.name === 'supplier' && preloadData['supplier']) {
            let found = preloadData['supplier'].find(opt => opt.id == row['supplier']);
            let label = found ? found.name : '';
            tr += `<td>${label}</td>`;
          } else if (f.type === "select" && preloadData[f.source]) {
            let found = preloadData[f.source].find(opt => opt.id == row[f.name]);
            let label = found ? (found.categoryname || found.unit || found.name) : '';
            tr += `<td>${label}</td>`;
          } else if (f.name === 'stock' && isLowStock) {
            tr += `<td>${row[f.name] ?? ''} <span title='Low Stock' style='color:#e74c3c;font-weight:bold;'>&#9888;</span></td>`;
          } else {
            tr += `<td>${row[f.name] ?? ''}</td>`;
          }
        });
        tr += `<td class="actions">`;
        tr += `<button onclick="startEdit(${row.id})"><svg width="16" height="16" fill="none" viewBox="0 0 20 20"><path d="M4 13.5V16h2.5l7.37-7.37-2.5-2.5L4 13.5zm11.71-6.29a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.92 3.92 1.83-1.83z" fill="#fff"/></svg> Edit</button>`;
        if (currentTab === 'products') {
          tr += `<button onclick="showStockInHistory(${row.id})" title="View Stock In History"><svg width='16' height='16' fill='none' viewBox='0 0 20 20'><path d='M4 10h12M10 4v12' stroke='#2563eb' stroke-width='2'/></svg> Stock In</button>`;
        }
        tr += `<button onclick="deleteRow(${row.id})"><svg width="16" height="16" fill="none" viewBox="0 0 20 20"><rect x="5" y="9" width="10" height="7" rx="2" fill="#fff" fill-opacity="0.7"/><rect x="7" y="5" width="6" height="2" rx="1" fill="#fff" fill-opacity="0.7"/></svg> Delete</button>`;
        tr += `</td></tr>`;
        tbody.innerHTML += tr;
      });
    }

    function onSearchInput() {
      renderTableRows();
    }

    function getFormData() {
      const cfg = tables[currentTab];
      const form = document.getElementById('crud-form');
      const obj = {};
      cfg.fields.forEach(f => {
        obj[f.name] = form[f.name].value;
      });
      return obj;
    }

    function submitAdd() {
      const cfg = tables[currentTab];
      const data = getFormData();
      fetch(cfg.endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          renderCRUD();
        } else {
          showError('Add failed');
        }
      });
    }

    function startEdit(id) {
      editingId = id;
      renderCRUD(() => {
        // Fill form after DOM and select options are ready
        const row = dataCache.find(r => r.id == id);
        if (row) {
          const form = document.getElementById('crud-form');
          tables[currentTab].fields.forEach(f => {
            if (f.type === "select") {
              const select = form[f.name];
              if (select) select.value = row[f.name] ?? '';
            } else {
              form[f.name].value = row[f.name] ?? '';
            }
          });
        }
      });
    }

    function submitEdit() {
      const cfg = tables[currentTab];
      const data = getFormData();
      fetch(cfg.endpoint + '?id=' + editingId, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          editingId = null;
          renderCRUD();
        } else {
          showError('Update failed');
        }
      });
    }

    function deleteRow(id) {
      if (!confirm('Delete this record?')) return;
      const cfg = tables[currentTab];
      fetch(cfg.endpoint + '?id=' + id, { method: 'DELETE' })
        .then(res => res.json())
        .then(res => {
          if (res.success) renderCRUD();
          else showError('Delete failed');
        });
    }

    function cancelEdit() {
      editingId = null;
      renderCRUD();
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function editCartQty(idx, val) {
      let q = Math.max(1, Number(val)||1);
      cart[idx].quantity = q;
      cart[idx].subtotal = q * cart[idx].price;
      renderSaleUI();
    }

    function onSaleProductChange(val) {
      saleForm.product_id = val;
      const p = productsList.find(p=>p.id==val);
      saleForm.price = p ? p.price : 0;
      renderSaleUI();
    }
    function onSaleQtyChange(val) {
      saleForm.quantity = Number(val)||1;
      renderSaleUI();
    }
    function onSalePriceChange(val) {
      saleForm.price = Number(val)||0;
      renderSaleUI();
    }
    function addToCart() {
      const form = document.getElementById('sale-form');
      const product_id = form.product_id.value;
      const quantity = Number(form.quantity.value)||1;
      const price = Number(form.price.value)||0;
      if (!product_id || quantity<=0) return;
      const subtotal = quantity * price;
      // If product already in cart, increase qty/subtotal
      const existing = cart.find(item => item.product_id === product_id);
      if (existing) {
        existing.quantity += quantity;
        existing.subtotal = existing.quantity * existing.price;
      } else {
        cart.push({ product_id, quantity, price, subtotal });
      }
      saleForm.product_id = '';
      saleForm.quantity = 1;
      saleForm.price = 0;
      renderSaleUI();
      setTimeout(()=>{
        document.querySelector('#sale-form select[name=product_id]').focus();
      }, 100);
    }
    function removeCartItem(idx) {
      cart.splice(idx,1);
      renderSaleUI();
    }
    function fetchSalesHistory() {
      return fetch(tables.sales.endpoint)
        .then(res => res.json())
        .then(data => { salesHistory = data; });
    }

    function showSaleInvoice(saleId) {
      const sale = salesHistory.find(s => s.id == saleId);
      if (!sale) return;
      // Compose invoice data from sale
      lastInvoice = {
        id: sale.id,
        date: sale.sale_date,
        customer: customersList.find(c=>c.id==sale.customer_id)?.name||'',
        staff: staffList.find(s=>s.id==sale.staff_id)?.name||'',
        items: (sale.items||[]).map(item=>(
          {
            name: item.productname||'',
            quantity: item.quantity,
            price: item.price,
            subtotal: item.subtotal
          }
        )),
        subtotal: sale.items ? sale.items.reduce((sum, i)=>sum+Number(i.subtotal),0) : Number(sale.total),
        discount: 0, // Not stored in DB, so show 0
        total: Number(sale.total),
        payment: sale.payment !== undefined ? Number(sale.payment) : Number(sale.total),
        change: sale.payment !== undefined ? Number(sale.payment) - Number(sale.total) : 0,
        note: sale.note
      };
      showInvoice = true;
      renderSaleUI();
    }

    function checkoutSale() {
      const form = document.getElementById('checkout-form');
      const customer_id = form.customer_id.value;
      const staff_id = form.staff_id.value;
      const note = form.note.value;
      const discount = Number(form.discount)||0;
      // Always get payment from the input field, not from saleForm
      const payment = Number(form.payment.value)||0;
      saleForm.payment = payment; // sync saleForm.payment for UI
      if (!customer_id || !staff_id || cart.length===0) return;
      let subtotal = cart.reduce((sum, item) => sum + Number(item.subtotal), 0);
      let discountAmount = discount > 0 ? (discount < 1 ? subtotal * discount : discount) : 0;
      let grandTotal = subtotal - discountAmount;
      saleLoading = true;
      saleMessage = '';
      renderSaleUI();
      fetch(tables.sales.endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          sale_date: new Date().toISOString().slice(0,19).replace('T',' '),
          customer_id, staff_id, total: grandTotal, note,
          payment, // ← payment ကိုထည့်ပို့
          items: cart
        })
      })
      .then(res=>res.json())
      .then(res=>{
        saleLoading = false;
        if (res.success) {
          lastInvoice = {
            id: res.id,
            date: new Date().toLocaleString(),
            customer: customersList.find(c=>c.id==customer_id)?.name||'',
            staff: staffList.find(s=>s.id==staff_id)?.name||'',
            items: cart.map(item=>(
              {
                name: productsList.find(p=>p.id==item.product_id)?.productname||'',
                quantity: item.quantity,
                price: item.price,
                subtotal: item.subtotal
              }
            )),
            subtotal,
            discount: discountAmount,
            total: grandTotal,
            payment: payment, // always use the latest payment from the form
            change: payment - grandTotal, // ← change မှန်အောင်
            note
          };
          cart = [];
          saleForm = { product_id: '', quantity: 1, price: 0, customer_id: '', staff_id: '', note: '', discount: 0, payment: 0 };
          saleMessage = '';
          showInvoice = true;
          fetchSalesHistory().then(()=>renderSaleUI());
        } else {
          saleMessage = 'Checkout failed!';
          renderSaleUI();
        }
      });
    }

    function renderInvoiceModal(inv) {
      // Calculate change for display
      let payment = inv.payment !== undefined ? inv.payment : 0;
      let change = payment - inv.total;
      return `<div id="invoice-modal" style="position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;box-shadow:0 2px 12px #0002;padding:0;min-width:320px;max-width:95vw;width:370px;">
          <div id="voucher-print-area" style="padding:32px 24px 18px 24px;font-family:monospace;color:#222;background:#fff;">
            <div style="text-align:center;margin-bottom:8px;">
              <div style="font-size:1.25em;font-weight:bold;letter-spacing:1px;">MY POS STORE</div>
              <div style="font-size:1em;">No.123, Main Road, Yangon</div>
              <div style="font-size:0.98em;">09-123456789</div>
            </div>
            <div style="border-top:1px dashed #888;border-bottom:1px dashed #888;padding:6px 0 6px 0;margin-bottom:8px;text-align:center;font-size:1.1em;font-weight:bold;">RECEIPT / INVOICE</div>
            <div style="font-size:0.98em;margin-bottom:2px;">Date: <b>${inv.date}</b></div>
            <div style="font-size:0.98em;margin-bottom:2px;">Sale ID: <b>${inv.id}</b></div>
            <div style="font-size:0.98em;margin-bottom:2px;">Customer: <b>${inv.customer}</b></div>
            <div style="font-size:0.98em;margin-bottom:8px;">Staff: <b>${inv.staff}</b></div>
            <table style="width:100%;font-size:1em;margin-bottom:8px;border-collapse:collapse;">
              <thead><tr style="border-bottom:1px solid #bbb;"><th style="text-align:left;font-weight:bold;">Item</th><th style="text-align:right;font-weight:bold;">Qty</th><th style="text-align:right;font-weight:bold;">Price</th><th style="text-align:right;font-weight:bold;">Amt</th></tr></thead>
              <tbody>
                ${inv.items.map(item=>`<tr><td>${item.name}</td><td style="text-align:right;">${item.quantity}</td><td style="text-align:right;">${Number(item.price).toFixed(2)}</td><td style="text-align:right;">${Number(item.subtotal).toFixed(2)}</td></tr>`).join('')}
              </tbody>
            </table>
            <div style="border-top:1px dashed #888;margin:8px 0 8px 0;"></div>
            <div style="display:flex;justify-content:space-between;font-size:1em;"><span>Subtotal</span><b>${Number(inv.subtotal).toFixed(2)}</b></div>
            <div style="display:flex;justify-content:space-between;font-size:1em;"><span>Discount</span><b>${Number(inv.discount).toFixed(2)}</b></div>
            <div style="display:flex;justify-content:space-between;font-size:1.1em;"><span>Total</span><b>${Number(inv.total).toFixed(2)}</b></div>
            <div style="display:flex;justify-content:space-between;font-size:1em;"><span>Payment</span><b>${Number(payment).toFixed(2)}</b></div>
            <div style="display:flex;justify-content:space-between;font-size:1em;"><span>Change</span><b>${change.toFixed(2)}</b></div>
            <div style="font-size:0.98em;margin:8px 0 0 0;color:#555;">Note: ${inv.note||'-'}</div>
            <div style="text-align:center;margin-top:16px;font-size:1.08em;font-weight:bold;letter-spacing:1px;">Thank you for your purchase!</div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:10px;padding:12px 18px 18px 18px;background:#fff;border-radius:0 0 10px 10px;">
            <button class="pos-btn" onclick="printVoucher()">Print</button>
            <button class="pos-btn cancel" onclick="closeInvoiceModal()">Close</button>
          </div>
        </div>
      </div>`;
    }

    function closeInvoiceModal() {
      showInvoice = false;
      renderSaleUI();
    }

    function printVoucher() {
      const printContents = document.getElementById('voucher-print-area').innerHTML;
      const win = window.open('', '', 'width=1200,height=600');
      win.document.write('<html><head><title>Print Voucher</title><style>body{background:#fff!important;color:#222!important;font-family:monospace;}@media print{body{background:#fff!important;color:#222!important;}}</style></head><body>' + printContents + '</body></html>');
      win.document.close();
      win.focus();
      setTimeout(()=>{win.print();win.close();}, 300);
    }

    function renderSalesHistoryTab() {
      preloadSaleData().then(() => {
        fetchSalesHistory().then(() => {
          let salesRows = salesHistory.map(sale => `
            <tr>
              <td>${sale.sale_date ? sale.sale_date.replace('T',' ').slice(0,19) : ''}</td>
              <td>${customersList.find(c=>c.id==sale.customer_id)?.name||''}</td>
              <td>${staffList.find(s=>s.id==sale.staff_id)?.name||''}</td>
              <td>${Number(sale.total).toFixed(2)}</td>
              <td>${sale.payment !== undefined ? Number(sale.payment).toFixed(2) : '-'}</td>
              <td>${sale.payment !== undefined && sale.total !== undefined ? (Number(sale.payment) - Number(sale.total)).toFixed(2) : '-'}</td>
              <td><button class="pos-btn" style="padding:4px 12px;font-size:0.95em" onclick="showSaleInvoice(${sale.id})">View</button></td>
            </tr>
          `).join('');
          document.getElementById('crud-app').innerHTML = `
            <h2>Sales History</h2>
            <div class="pos-card">
              <div class="pos-table-wrap">
                <table><thead><tr><th>Date</th><th>Customer</th><th>Staff</th><th>Total</th><th>Payment</th><th>Change</th><th>Invoice</th></tr></thead>
                <tbody>${salesRows || '<tr><td colspan="7" style="text-align:center;color:#aaa;">No sales yet</td></tr>'}</tbody></table>
              </div>
            </div>
            ${showInvoice && lastInvoice ? renderInvoiceModal(lastInvoice) : ''}
          `;
        });
      });
    }

    function renderReportsPage() {
      document.getElementById('crud-app').innerHTML = `
        <h2>Reports</h2>
        <div class="pos-card">
          <h3>Sales & Profit Report</h3>
          <form id="report-form">
            <div class="pos-form-row">
              <label>Type
                <select name="type">
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                  <option value="product">By Product</option>
                </select>
              </label>
              <label>Month/Year
                <input name="period" type="month" value="${new Date().toISOString().slice(0,7)}">
              </label>
            </div>
            <div class="pos-form-actions">
              <button type="submit" class="pos-btn">Show Report</button>
            </div>
          </form>
          <div id="report-result"></div>
        </div>
      `;
      document.getElementById('report-form').onsubmit = showReport;
    }
    function showReport(e) {
      e.preventDefault();
      document.getElementById('report-result').innerHTML = '<div style="text-align:center;">Loading...</div>';
      const form = document.getElementById('report-form');
      const type = form.type.value;
      let period = form.period.value;
      if (type === 'yearly') period = period.slice(0,4);
      fetch(`api/sales.php?report=1&type=${type}&period=${period}`)
        .then(res => res.json())
        .then(data => {
          let html = `<div style='font-size:1.1em;margin-bottom:10px;'>
            <b>Total Sales:</b> ${Number(data.total).toFixed(2)}<br>
            <b>Total Profit:</b> ${Number(data.profit).toFixed(2)}
          </div>`;
          if (data.byProduct && data.byProduct.length) {
            html += `<table style='width:100%;font-size:1em;margin-bottom:8px;border-collapse:collapse;'>
              <thead><tr><th>Product</th><th>Qty</th><th>Sales</th><th>Profit</th></tr></thead>
              <tbody>
                ${data.byProduct.map(p=>`<tr><td>${p.name||''}</td><td>${p.qty}</td><td>${Number(p.total).toFixed(2)}</td><td>${Number(p.profit).toFixed(2)}</td></tr>`).join('')}
              </tbody>
            </table>`;
          }
          document.getElementById('report-result').innerHTML = html;
        });
    }

    function renderSettingsPage() {
      document.getElementById('crud-app').innerHTML = `
        <h2>Settings</h2>
        <div class="pos-card">
          <h3>Store Info (Voucher/Invoice)</h3>
          <form id="store-info-form">
            <div class="pos-form-row">
              <label>Store Name <input name="store_name" type="text" placeholder="Store Name"></label>
              <label>Contact No <input name="store_contact" type="text" placeholder="Contact No"></label>
              <label>Address <input name="store_address" type="text" placeholder="Address"></label>
            </div>
            <div class="pos-form-actions">
              <button type="submit" class="pos-btn">Save Store Info</button>
            </div>
          </form>
        </div>
        <div class="pos-card">
          <h3>Product Stock Notification</h3>
          <form id="stock-noti-form">
            <div class="pos-form-row">
              <label>Default Stock Noti Threshold <input name="stock_noti_default" type="number" min="0" value="5"></label>
            </div>
            <div class="pos-form-actions">
              <button type="submit" class="pos-btn">Save Stock Noti Setting</button>
            </div>
          </form>
        </div>
        <div class="pos-card">
          <h3>Backup / Restore</h3>
          <div class="pos-form-actions">
            <button class="pos-btn" onclick="backupDatabase()">Backup Data</button>
            <input type="file" id="restore-file" style="display:none" onchange="restoreDatabase(event)">
            <button class="pos-btn" onclick="document.getElementById('restore-file').click()">Restore Data</button>
          </div>
        </div>
        <div class="pos-card">
          <h3>Delete Data</h3>
          <div class="pos-form-actions">
            <button class="pos-btn cancel" onclick="deleteAllData()">Delete All Data</button>
          </div>
        </div>
      `;
    }

    // Store Info (Settings)
    function saveStoreInfo(e) {
      e.preventDefault();
      const form = document.getElementById('store-info-form');
      const info = {
        name: form.store_name.value,
        contact: form.store_contact.value,
        address: form.store_address.value
      };
      localStorage.setItem('store_info', JSON.stringify(info));
      alert('Store info saved!');
    }

    function loadStoreInfoToForm() {
      const form = document.getElementById('store-info-form');
      if (!form) return;
      const info = JSON.parse(localStorage.getItem('store_info') || '{}');
      form.store_name.value = info.name || '';
      form.store_contact.value = info.contact || '';
      form.store_address.value = info.address || '';
    }

    // Patch renderSettingsPage to attach event
    const origRenderSettingsPage = renderSettingsPage;
    renderSettingsPage = function() {
      origRenderSettingsPage();
      loadStoreInfoToForm();
      document.getElementById('store-info-form').onsubmit = saveStoreInfo;
    }

    // Patch renderInvoiceModal to use store info
    const origRenderInvoiceModal = renderInvoiceModal;
    renderInvoiceModal = function(inv) {
      const info = JSON.parse(localStorage.getItem('store_info') || '{}');
      let storeName = info.name || 'MY POS STORE';
      let storeContact = info.contact || '09-123456789';
      let storeAddress = info.address || 'No.123, Main Road, Yangon';
      return origRenderInvoiceModal(inv)
        .replace('MY POS STORE', storeName)
        .replace('09-123456789', storeContact)
        .replace('No.123, Main Road, Yangon', storeAddress);
    }

    // Stock Noti Default (Settings)
    function saveStockNotiDefault(e) {
      e.preventDefault();
      const form = document.getElementById('stock-noti-form');
      const val = Number(form.stock_noti_default.value) || 5;
      localStorage.setItem('stock_noti_default', val);
      alert('Default stock notification threshold saved!');
    }

    function loadStockNotiDefaultToForm() {
      const form = document.getElementById('stock-noti-form');
      if (!form) return;
      const val = localStorage.getItem('stock_noti_default') || '5';
      form.stock_noti_default.value = val;
    }

    // Patch renderSettingsPage to attach event for stock noti default
    const origRenderSettingsPage2 = renderSettingsPage;
    renderSettingsPage = function() {
      origRenderSettingsPage2();
      loadStoreInfoToForm();
      document.getElementById('store-info-form').onsubmit = saveStoreInfo;
      loadStockNotiDefaultToForm();
      document.getElementById('stock-noti-form').onsubmit = saveStockNotiDefault;
    }

    // Patch renderCRUD to set default stock_noti when adding product
    const origRenderCRUD = renderCRUD;
    renderCRUD = function(afterRender) {
      origRenderCRUD(function() {
        if (currentTab === 'products' && !editingId) {
          // Only for add, not edit
          const form = document.getElementById('crud-form');
          if (form && form.querySelector('input[name="image"]')) {
            const imgInput = form.querySelector('input[name="image"]');
            if (imgInput.files.length > 0) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const imgPrev = document.createElement('img');
                imgPrev.src = e.target.result;
                imgPrev.style.maxWidth = '60px';
                imgPrev.style.display = 'block';
                imgPrev.style.marginTop = '5px';
                form.querySelector('.pos-form-row').appendChild(imgPrev);
              };
              reader.readAsDataURL(imgInput.files[0]);
            }
          }
          if (form && !form.querySelector('input[name="stock_noti"]')) {
            const stockNotiLabel = document.createElement('label');
            stockNotiLabel.textContent = 'Stock Noti Threshold';
            const stockNotiInput = document.createElement('input');
            stockNotiInput.type = 'number';
            stockNotiInput.name = 'stock_noti';
            stockNotiInput.min = '0';
            stockNotiInput.value = localStorage.getItem('stock_noti_default') || '5';
            stockNotiLabel.appendChild(stockNotiInput);
            form.querySelector('.pos-form-row').appendChild(stockNotiLabel);
          }
        }
        if (afterRender) afterRender();
      });
    }

    // Patch addToCart to show alert if stock not ok
    const origAddToCart = addToCart;
    addToCart = function() {
      let selectedProduct = productsList.find(p=>p.id==saleForm.product_id);
      if (selectedProduct) {
        let threshold = Number(selectedProduct.stock_noti ?? 5);
        let stock = Number(selectedProduct.stock ?? 0);
        let qty = Number(document.getElementById('sale-form').quantity.value) || 1;
        if (stock < threshold || stock < qty || stock <= 0) {
          alert(stock <= 0 ? 'Out of stock!' : (stock < qty ? 'Not enough stock!' : 'Stock is below notification threshold!'));
          return;
        }
      }
      origAddToCart();
    }

    // Patch checkoutSale to block if any cart item is out of stock
    const origCheckoutSale = checkoutSale;
    checkoutSale = function() {
      for (let item of cart) {
        let p = productsList.find(p=>p.id==item.product_id);
        if (p) {
          let stock = Number(p.stock ?? 0);
          if (item.quantity > stock) {
            alert(`Cannot checkout: Not enough stock for ${p.productname}`);
            return;
          }
          if (stock <= 0) {
            alert(`Cannot checkout: ${p.productname} is out of stock!`);
            return;
          }
        }
      }
      origCheckoutSale();
    }

    // Backup/Restore
    function backupDatabase() {
      fetch('database.db')
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'database_backup.db';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          }, 100);
        });
    }

    function restoreDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!confirm('Restore will overwrite all data. Continue?')) return;
      const formData = new FormData();
      formData.append('dbfile', file);
      fetch('restore_db.php', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          alert('Database restored! Please reload the page.');
        } else {
          alert('Restore failed!');
        }
      });
    }

    function deleteAllData() {
      if (!confirm('Are you sure you want to delete ALL data? This cannot be undone!')) return;
      fetch('delete_all_data.php', { method: 'POST' })
        .then(res => res.json())
        .then(res => {
          if (res.success) {
            alert('All data deleted! Please reload the page.');
          } else {
            alert('Delete failed!');
          }
        });
    }

    // Stock In History Modal
    function showStockInHistory(productId) {
      fetch(`api/products.php?stock_in_history=1&product_id=${productId}`)
        .then(res => res.json())
        .then(list => {
          let html = `<div id='stock-in-modal' style='position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;'>
            <div style='background:#fff;border-radius:10px;box-shadow:0 2px 12px #0002;padding:0;min-width:320px;max-width:95vw;width:370px;'>
              <div style='padding:24px 18px 10px 18px;'>
                <h3 style='margin:0 0 10px 0;'>Stock In History</h3>
                <table style='width:100%;font-size:1em;margin-bottom:8px;border-collapse:collapse;'>
                  <thead><tr><th>Date</th><th>Qty</th><th>Note</th></tr></thead>
                  <tbody>
                    ${list.map(item=>`<tr><td>${item.created_at}</td><td>${item.qty}</td><td>${item.note||''}</td></tr>`).join('')}
                  </tbody>
                </table>
                <div style='text-align:right;'><button class='pos-btn cancel' onclick='closeStockInModal()'>Close</button></div>
              </div>
            </div>
          </div>`;
          document.body.insertAdjacentHTML('beforeend', html);
        });
    }
    function closeStockInModal() {
      const m = document.getElementById('stock-in-modal');
      if (m) m.remove();
    }

    // --- PATCH renderCRUD for product image upload ---
    const origRenderCRUD2 = renderCRUD;
    renderCRUD = function(afterRender) {
      origRenderCRUD2(function() {
        if (currentTab === 'products') {
          // Add image input to form
          const form = document.getElementById('crud-form');
          if (form && !form.querySelector('input[name="image"]')) {
            const imgLabel = document.createElement('label');
            imgLabel.textContent = 'Image';
            const imgInput = document.createElement('input');
            imgInput.type = 'file';
            imgInput.name = 'image';
            imgInput.accept = 'image/*';
            imgInput.style.marginTop = '5px';
            imgLabel.appendChild(imgInput);
            form.querySelector('.pos-form-row').appendChild(imgLabel);
            // Preview for edit
            if (editingId) {
              const row = dataCache.find(r => r.id == editingId);
              if (row && row.image_url) {
                const imgPrev = document.createElement('img');
                imgPrev.src = row.image_url;
                imgPrev.style.maxWidth = '60px';
                imgPrev.style.display = 'block';
                imgPrev.style.marginTop = '5px';
                imgLabel.appendChild(imgPrev);
              }
            }
          }
          // Patch submitAdd/submitEdit for image
          form.onsubmit = function(e) {
            e.preventDefault();
            const isEdit = !!editingId;
            const fd = new FormData(form);
            tables.products.fields.forEach(f => {
              if (!fd.has(f.name)) fd.append(f.name, form[f.name]?.value || '');
            });
            if (isEdit) {
              fetch(tables.products.endpoint + '?id=' + editingId, {
                method: 'PUT',
                body: fd
              })
              .then(res => res.json())
              .then(res => {
                if (res.success) {
                  editingId = null;
                  renderCRUD();
                } else {
                  showError('Update failed');
                }
              });
            } else {
              fetch(tables.products.endpoint, {
                method: 'POST',
                body: fd
              })
              .then(res => res.json())
              .then(res => {
                if (res.success) {
                  renderCRUD();
                } else {
                  showError('Add failed');
                }
              });
            }
          };
        }
        if (afterRender) afterRender();
      });
    };
    // --- PATCH renderTableRows to show product image ---
    const origRenderTableRows = renderTableRows;
    renderTableRows = function() {
      const cfg = tables[currentTab];
      const search = (document.getElementById('search-bar')?.value || '').toLowerCase();
      const tbody = document.getElementById('crud-tbody');
      tbody.innerHTML = '';
      let filtered = dataCache;
      if (search) {
        filtered = dataCache.filter(row =>
          cfg.fields.some(f => (row[f.name] + '').toLowerCase().includes(search))
        );
      }
      filtered.forEach(row => {
        const isEdit = editingId == row.id;
        let isLowStock = false;
        if (currentTab === 'products') {
          const stock = Number(row['stock'] ?? 0);
          const threshold = Number(row['stock_noti'] ?? 5);
          isLowStock = stock < threshold;
        }
        let tr = `<tr${isEdit ? ' class="edit-row"' : ''}${isLowStock ? ' style="background:#fff0f0;"' : ''}>`;
        if (currentTab === 'products') {
          // Show image as first column
          tr += `<td>${row.image_url ? `<img src='${row.image_url}' style='max-width:48px;max-height:48px;border-radius:6px;'/>` : ''}</td>`;
        }
        cfg.fields.forEach(f => {
          if (f.name === 'supplier' && preloadData['supplier']) {
            let found = preloadData['supplier'].find(opt => opt.id == row['supplier']);
            let label = found ? found.name : '';
            tr += `<td>${label}</td>`;
          } else if (f.type === "select" && preloadData[f.source]) {
            let found = preloadData[f.source].find(opt => opt.id == row[f.name]);
            let label = found ? (found.categoryname || found.unit || found.name) : '';
            tr += `<td>${label}</td>`;
          } else if (f.name === 'stock' && isLowStock) {
            tr += `<td>${row[f.name] ?? ''} <span title='Low Stock' style='color:#e74c3c;font-weight:bold;'>&#9888;</span></td>`;
          } else {
            tr += `<td>${row[f.name] ?? ''}</td>`;
          }
        });
        tr += `<td class="actions">`;
        tr += `<button onclick="startEdit(${row.id})"><svg width="16" height="16" fill="none" viewBox="0 0 20 20"><path d="M4 13.5V16h2.5l7.37-7.37-2.5-2.5L4 13.5zm11.71-6.29a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.92 3.92 1.83-1.83z" fill="#fff"/></svg> Edit</button>`;
        if (currentTab === 'products') {
          tr += `<button onclick="showStockInHistory(${row.id})" title="View Stock In History"><svg width='16' height='16' fill='none' viewBox='0 0 20 20'><path d='M4 10h12M10 4v12' stroke='#2563eb' stroke-width='2'/></svg> Stock In</button>`;
        }
        tr += `<button onclick="deleteRow(${row.id})"><svg width="16" height="16" fill="none" viewBox="0 0 20 20"><rect x="5" y="9" width="10" height="7" rx="2" fill="#fff" fill-opacity="0.7"/><rect x="7" y="5" width="6" height="2" rx="1" fill="#fff" fill-opacity="0.7"/></svg> Delete</button>`;
        tr += `</td></tr>`;
        tbody.innerHTML += tr;
      });
    };
    // --- PATCH renderCRUD to add image column header for products ---
    const origRenderCRUD3 = renderCRUD;
    renderCRUD = function(afterRender) {
      origRenderCRUD3(function() {
        if (currentTab === 'products') {
          // Add image column header if not present
          const ths = document.querySelectorAll('#crud-app th');
          if (ths.length && ths[0].textContent !== 'Image') {
            const tr = ths[0].parentElement;
            const imgTh = document.createElement('th');
            imgTh.textContent = 'Image';
            tr.insertBefore(imgTh, tr.firstChild);
          }
        }
        if (afterRender) afterRender();
      });
    };
    // --- Supplier Purchase Report ---
    const origRenderReportsPage = renderReportsPage;
    renderReportsPage = function() {
      origRenderReportsPage();
      // Add Supplier Purchase Report UI
      const reportsDiv = document.getElementById('crud-app');
      const card = document.createElement('div');
      card.className = 'pos-card';
      card.innerHTML = `<h3>Supplier Purchase Report</h3>
        <form id='supplier-report-form'>
          <div class='pos-form-row'>
            <label>Supplier
              <select name='supplier_id' id='supplier-select'><option value=''>-- Select Supplier --</option></select>
            </label>
          </div>
          <div class='pos-form-actions'><button type='submit' class='pos-btn'>Show Report</button></div>
        </form>
        <div id='supplier-report-result'></div>`;
      reportsDiv.appendChild(card);
      // Load suppliers
      fetch(tables.supplier.endpoint)
        .then(res=>res.json())
        .then(list=>{
          const sel = document.getElementById('supplier-select');
          list.forEach(sup=>{
            const opt = document.createElement('option');
            opt.value = sup.id;
            opt.textContent = sup.name;
            sel.appendChild(opt);
          });
        });
      document.getElementById('supplier-report-form').onsubmit = function(e) {
        e.preventDefault();
        const supplier_id = document.getElementById('supplier-select').value;
        if (!supplier_id) return;
        document.getElementById('supplier-report-result').innerHTML = 'Loading...';
        fetch('api/purchase.php?report=1&supplier_id='+supplier_id)
          .then(res=>res.json())
          .then(data=>{
            let html = `<div style='font-size:1.1em;margin-bottom:10px;'><b>Total Purchase:</b> ${Number(data.total).toFixed(2)}</div>`;
            if (data.purchases && data.purchases.length) {
              html += `<table style='width:100%;font-size:1em;margin-bottom:8px;border-collapse:collapse;'><thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Cost</th><th>Note</th></tr></thead><tbody>`;
              html += data.purchases.map(p=>`<tr><td>${p.date}</td><td>${p.productname||''}</td><td>${p.qty}</td><td>${Number(p.cost).toFixed(2)}</td><td>${p.note||''}</td></tr>`).join('');
              html += '</tbody></table>';
            } else {
              html += '<div style="color:#888;">No purchases found for this supplier.</div>';
            }
            document.getElementById('supplier-report-result').innerHTML = html;
          });
      };
    };

    // Initial render
    renderCRUD();
  </script>
</body>
</html>
